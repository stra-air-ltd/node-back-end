on:
  push:
    branches:
      - main
      - dev
  pull_request:
      types: [opened, synchronize, reopened]

name: SonarQube Scan
jobs:
  sonarqube:
    name: SonarQube Trigger
    runs-on: ubuntu-22.04
    steps:
    - name: Checking out
      uses: https://gitea.com/actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      run: |
        # 创建源列表目录
        mkdir -p /etc/apt/keyrings
        
        # 导入所有必需的 Debian 密钥
        curl -fsSL https://download.oracle.com/java/GPG-KEY-oracle-java | gpg --dearmor -o /etc/apt/keyrings/oracle-java.gpg
        
        # 添加Java仓库
        echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/oracle-java.gpg] https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main" | tee /etc/apt/sources.list.d/java.list
        
        # 更新并安装
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y openjdk-17-jdk
        
        # 验证安装
        java -version
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        export PATH=$JAVA_HOME/bin:$PATH

    - name: Install SonarScanner
      run: |
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export PATH=$JAVA_HOME/bin:$PATH
        wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
        unzip sonar-scanner-cli-4.8.0.2856-linux.zip
        mv sonar-scanner-4.8.0.2856-linux /opt/sonar-scanner
        echo "sonar.java.jdkHome=/usr/lib/jvm/java-17-openjdk-amd64" >> /opt/sonar-scanner/conf/sonar-scanner.properties

    - name: SonarQube Scan
      env:
        SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONARQUBE_HOST }}
      run: |
        /opt/sonar-scanner/bin/sonar-scanner \
          -Dsonar.projectKey=${{ github.repository }} \
          -Dsonar.sources=src \
          -Dsonar.host.url=${{ secrets.SONARQUBE_HOST }} \
          -Dsonar.login=${{ secrets.SONARQUBE_TOKEN }} \
          -Dsonar.sourceEncoding=UTF-8 \
          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
          -Dsonar.exclusions=**/node_modules/**,**/*.test.ts